---
title: è½¯ä»¶å¼€å‘é¡¹ç›®å®è·µï¼ˆå››ï¼‰
date: 2018-04-13 13:04:49
tags:
- Spring MVC
---

ğŸ˜”ç»ˆäºæœ€åä¸€ä¸ªå®éªŒäº†ã€‚ã€‚ã€‚

**1. åˆ©ç”¨SpringMVCæŠ€æœ¯å®Œæˆè‡ªå·±é¡¹ç›®çš„å‰ç«¯ç•Œé¢ä»¥åŠæ§åˆ¶å±‚ä»£ç ï¼ŒåŒ…æ‹¬å¢åŠ ã€ä¿®æ”¹ã€åˆ é™¤ã€æŸ¥è¯¢ç­‰åŠŸèƒ½ã€‚**

é¦–å…ˆæ˜ç¡®ä¸€ç‚¹ï¼Œæ˜¯ä½¿ç”¨SPring MVCæ¥å®Œæˆå¢åˆ æ”¹æŸ¥çš„åŠŸèƒ½ï¼Œé¦–å…ˆå¼•å…¥ç›¸å…³éœ€è¦çš„åŒ…ï¼Œå› ä¸ºéœ€è¦ä½¿ç”¨Annotationã€ORMã€logè®°å½•ã€mysqlè¿æ¥ã€‚

éœ€è¦å¯¼å…¥çš„jaråŒ…å¦‚ä¸‹æ‰€ç¤ºï¼š
1. jstl
2. standard
3. mybatis
4. mysql
5. log4j

åœ¨intelliJä¸­åˆ›å»ºSpring MVCå·¥ç¨‹ï¼Œå› ä¸ºæˆ‘ä»¬å¹¶ä¸æƒ³åƒä¹‹å‰ä¸€æ ·æ¯æ¬¡éƒ½æ‰‹æ‹¼SQLå’Œç®¡ç†JDBCçš„ç›¸å…³å†…å®¹ï¼Œå› æ­¤å¯ä»¥ç”¨ä¸ŠMyBatiså»å¸®åŠ©å‡å°‘å·¥ä½œé‡ï¼Œå…ˆæ¥å†™ä¸‹å¯¹åº”çš„é…ç½®æ–‡ä»¶

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- mapperæ ‡ç­¾è¦æŒ‡å®šnamespaceå±æ€§ï¼Œä¸ç„¶ä¼šæŠ¥é”™ï¼Œå¯çœ‹åšåŒ…å-->
<mapper namespace="com.pjhubs.DAO.UserMapper">
    <select id="selectUserWithID" parameterType="int" resultType="com.pjhubs.Model.User">
    select * from user where id = #{id}
</select>
    <select id="selectAllUser" resultType="com.pjhubs.Model.User">
    select * from user
</select>
    <insert id="insertUser" parameterType="com.pjhubs.Model.User">
    insert into user(nickname,passwd) values(#{nickname},#{passwd})
</insert>
    <delete id="deleteUserWithID" parameterType="int">
    delete from user where id=#{id}
</delete>
    <update id="updateUserWithNickname" parameterType="com.pjhubs.Model.User">
    update user set nickname=#{nickname} where id=#{id}
</update>
</mapper>

```

éšåå†å†™ä¸‹å¯¹MyBatisçš„é…ç½®æ–‡ä»¶,

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE configuration
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
    <environments default="development">
        <environment id="development">
            <transactionManager type="JDBC"/>
            <dataSource type="POOLED">
                <property name="driver" value="com.mysql.jdbc.Driver"/>
                <property name="url" value="jdbc:mysql://localhost:3306/your DB name?useSSL=false"/>
                <property name="username" value="your DB username"/>
                <property name="password" value="your DB passwd"/>
            </dataSource>
        </environment>
    </environments>
    <mappers>
        <!-- å¯¹åº”ä¸Šé¢sqlæ–‡ä»¶çš„è·¯å¾„ -->
        <mapper resource="com/pjhubs/User.xml"/>
    </mappers>
</configuration>
```

éšåæ¥å®šä¹‰`Usermodel`æ–‡ä»¶ï¼Œè¯¥modeléœ€è¦æ ¹æ®è‡ªå·±çš„è¡¨ç»“æ„è¿›è¡Œæ”¹é€ ï¼Œä¾›å‚è€ƒ

```java
package com.pjhubs.Model;

public class User {

    private Integer id;
    private String passwd;
    private String nickname;

    public Integer getId() {
        return id;
    }

    public void setId(Integer id) {
        this.id = id;
    }

    public String getPasswd() {
        return passwd;
    }

    public void setPasswd(String passwd) {
        this.passwd = passwd;
    }

    public String getNickname() {
        return nickname;
    }

    public void setNickname(String nickname) {
        this.nickname = nickname;
    }
}

```

æ¥ç€æ¥å®šä¹‰`UserMapper`æ–‡ä»¶ï¼Œå› ä¸ºMyBatisä¹Ÿæä¾›ç®€åŒ–äº†å¸®åŠ©æˆ‘ä»¬å‡å°‘å†™æ¨¡æ¿ä»£ç çš„æ­¥éª¤ã€‚æ³¨æ„ï¼Œå¦‚æœä½ å¹¶ä¸æƒ³è¯•ç”¨Mapperçš„åšæ³•ï¼Œè¯·åœ¨å¯¹åº”çš„SQLé…ç½®æ–‡ä»¶ä¸­çš„`<mapper namespace>`æ ‡ç­¾ä¸‹ä¿®æ”¹å¯¹åº”çš„å€¼ä¸ºä½ çš„DAOå±‚æ¥å£å®ç°æ–‡ä»¶ã€‚

```java
package com.pjhubs.DAO;

import java.util.List;
import com.pjhubs.Model.User;

public interface UserMapper {

    public User selectUserWithID(int ID) throws Exception;
    public List<User> selectAllUser() throws Exception;
    public void insertUser(User user) throws Exception;
    public void deleteUserWithID(int ID) throws Exception;
    public void updateUserWithNickname(User user) throws Exception;
}

```

ä»¥ä¸Šå°±æ˜¯æˆ‘ä»¬çš„å‡†å¤‡å·¥ä½œï¼Œæ¥ä¸‹æ¥å¼€å§‹æ­£å¼è¿›å…¥åˆ°ç¼–å†™SpringMVCçš„Controllerå±‚æ§åˆ¶ä»£ç ã€‚æ­¤å¤„çš„Controllerå±‚å¯ä»¥ç†è§£ä¸ºæ˜¯æ§åˆ¶æ•°æ®æºçš„ç´¢å–å’Œç»™è§†å›¾å¡«å…¥æ•°æ®ï¼Œè¿”å›è§†å›¾çš„ä¸­å¿ƒè€…ã€‚

å¯¹äºè¿™ä¸ªä¸­å¿ƒè€…ï¼Œéµå¾ªçš„å¯ä»¥æ˜¯MVCã€MVPã€MVVMç­‰æ¶æ„è®¾è®¡ä¸­å……å½“Cã€Pã€VMè§’è‰²ï¼Œæˆ‘ä»¬ä»Spring MVCçš„åå­—ä¸Šçœ‹ä¹Ÿèƒ½çœ‹å‡ºäº†è¯¥æ¡†æ¶éµå¾ªçš„MVCçš„æ¶æ„è®¾è®¡ï¼Œè€Œå¯¹äºMVCæœ€é‡è¦çš„äº‹æƒ…å°±æ˜¯Må’ŒVéƒ½è¦åˆ†å¼€ï¼Œå¹¶ä¸”Må’ŒVéƒ½äº’ç›¸çŸ¥é“å¯¹æ–¹çš„å­˜åœ¨ï¼Œè¿™å¯ä»¥è¯´æ˜¯MVCçš„å¥½å¤„ä¹Ÿå¯ä»¥è®¤ä¸ºæ˜¯MVCçš„åå¤„ï¼Œä»¥ä¸ºå†…MVPè¾¾åˆ°çš„æ˜¯Vä¸çŸ¥é“Mæ˜¯è°ï¼Œåªç®¡è‡ªå·±è¦çš„æ•°æ®æ˜¯ä»€ä¹ˆï¼Œåªéœ€è¦åœ¨Pä¸­å¡«å……ç»™Vå¯¹åº”çš„æ•°æ®å³å¯ï¼Œè€Œåœ¨MVVMä¸­ï¼ŒVå’ŒMåŒæ–¹éƒ½ä¸çŸ¥é“å¯¹æ–¹çš„å­˜åœ¨ï¼ŒVåªçŸ¥é“è‡ªå·±éœ€è¦å“ªäº›æ•°æ®ï¼ŒMåªçŸ¥é“è‡ªå·±èƒ½å¤Ÿè·å–åˆ°å“ªäº›æ•°æ®ï¼Œè€Œè´Ÿè´£å¯¹Vå’ŒMè¿›è¡Œæ•°æ®ç»‘å®šçš„åˆ™ç”±ViewModelæ¥åšã€‚

ä»¥ä¸Šå°±æ˜¯å¯¹MVCã€MVPã€MVVMä¸‰å¤§æ¶æ„è®¾è®¡çš„ä¸€ä¸ªç®€å•è®²è§£ï¼Œå¦‚æœä½ ä¹Ÿåšç§»åŠ¨åº”ç”¨å¼€å‘ç”šè‡³æ˜¯iOSå¼€å‘ï¼Œæƒ³è¦æ›´åŠ ç»†çš„å¯¹æ¶æ„è®¾è®¡æœ‰ä¸€ä¸ªæ›´åŠ æ·±å…¥çš„äº†è§£ï¼Œå¯ä»¥å‚è€ƒæˆ‘çš„[è¿™ç¯‡æ–‡ç« ](http://pjhubs.com/2018/02/02/More-DesignPattern/)ã€‚

æˆ‘ä»¬éœ€è¦ç”¨åˆ°Spring MVCæ¡†æ¶ä¸­æä¾›çš„ControlleråŠŸèƒ½ï¼Œä¹Ÿå¯ä»¥å…ˆæµ…æ˜¾çš„è®¤ä¸ºæ˜¯è·¯ç”±ä¸­å¿ƒï¼ˆä½†å¾ˆæ˜¾ç„¶å®ƒä¸åº”è¯¥æ˜¯ä¸­å¿ƒï¼‰ï¼Œæˆ‘ä»¬è®¿é—®çš„æ‰€æœ‰èµ„æºï¼Œæœ€ç»ˆéƒ½ä¼šè½å…¥åˆ°Controllerä¸­ï¼ˆå‰ææ”¹äº†é…ç½®æ–‡ä»¶ï¼‰ï¼Œåœ¨æ­£å¼å¼€å§‹ç¼–å†™Controllerä¸­å¿ƒè€…åŠŸèƒ½å‰ï¼Œæˆ‘ä»¬ç°åœ¨æ¥é…ç½®æ¡†æ¶çš„é…ç½®æ–‡ä»¶ï¼Œå¦‚æœä½ ä¹Ÿæ˜¯ç”¨intelliJåˆ›å»ºçš„å·¥ç¨‹ï¼Œè¯¥é…ç½®æ–‡ä»¶çš„åç§°åº”ä¸º`applicationContext.xml`ï¼Œåƒä¸‡æ³¨æ„ç›¸å…³æ–‡ä»¶çš„è·¯å¾„ï¼ï¼ï¼

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:mvc="http://www.springframework.org/schema/mvc"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/context
       http://www.springframework.org/schema/context/spring-context.xsd
       http://www.springframework.org/schema/mvc
       http://www.springframework.org/schema/mvc/spring-mvc.xsd">

    <context:component-scan base-package="com.pjhubs.controller"/>
    <!-- é™æ€èµ„æº(jsã€imageç­‰)çš„è®¿é—® -->
    <mvc:default-servlet-handler/>
    <!-- å¼€å¯æ³¨è§£ -->
    <mvc:annotation-driven/>
    <!-- mappingåè·Ÿçš„ä¸ºURLè®¿é—®æ—¶çš„æ˜ å°„è·¯å¾„ -->
    <mvc:resources location="/WEB-INF/resource/scripts/js/" mapping="/js/**"></mvc:resources>

    <!--ViewResolver è§†å›¾è§£æå™¨-->
    <!--ç”¨äºæ”¯æŒServletã€JSPè§†å›¾è§£æ-->
    <bean id="jspViewResolver" class="org.springframework.web.servlet.view.InternalResourceViewResolver">
        <property name="viewClass" value="org.springframework.web.servlet.view.JstlView"/>
        <property name="prefix" value="/WEB-INF/Views/"/>
        <property name="suffix" value=".jsp"/>
    </bean>

</beans>
```

ä¸ºäº†é™ä½å®éªŒçš„å¤æ‚åº¦ï¼ˆæˆ‘å°±æ˜¯æ‡’ï¼‰ï¼Œè°¢ç»è€ƒè™‘å…¶ä»–ä¸€åˆ‡ä¸ç›¸å¹²é—®é¢˜ï¼Œä¿®æ”¹`dispatcher-servlet.xml`æ–‡ä»¶å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼Œ
```xml
<?xml version="1.0" encoding="UTF-8"?>
<web-app xmlns="http://xmlns.jcp.org/xml/ns/javaee"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"
         version="4.0">
    <context-param>
        <param-name>contextConfigLocation</param-name>
        <param-value>/WEB-INF/applicationContext.xml</param-value>
    </context-param>
    <listener>
        <listener-class>org.springframework.web.context.ContextLoaderListener</listener-class>
    </listener>
    <servlet>
        <servlet-name>dispatcher</servlet-name>
        <servlet-class>org.springframework.web.servlet.DispatcherServlet</servlet-class>
        <load-on-startup>1</load-on-startup>
    </servlet>
    <servlet-mapping>
        <!-- é‡ç‚¹æ˜¯å®ƒ, æˆªå–æ‰€æœ‰è®¿é—®å…¥Spring-->
        <servlet-name>dispatcher</servlet-name>
        <url-pattern>/</url-pattern>
    </servlet-mapping>
</web-app>
```

ç°åœ¨æˆ‘ä»¬å°±å…ˆæ¥å®Œæˆçš„Controllerä»£ç ã€‚

```java
package com.pjhubs.controller;

import org.apache.ibatis.io.Resources;
import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;
import org.apache.ibatis.session.SqlSessionFactoryBuilder;

import org.springframework.stereotype.Controller;
import org.springframework.ui.ModelMap;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;

import javax.annotation.Resource;
import java.io.InputStream;
import java.util.List;

import com.pjhubs.DAO.UserMapper;
import com.pjhubs.Model.User;

@Controller
public class thingsController {

    // ç›´æ¥è®¿é—®æ ¹åœ°å€å®šä½åˆ°è¿™
    @RequestMapping(value = "/", method = RequestMethod.GET)
    public String todoList(ModelMap modelMap) {
        modelMap.addAttribute("msg", "To-do List");
        return "todolist";
    }

    // è®¿é—® /allThingså®šä½åˆ°è¿™
    @RequestMapping(value = "/allThings", method = RequestMethod.GET)
    public List<User> allThings(ModelMap modelMap) throws Exception {

        String resource = "com/pjhubs/SqlMapConfig.xml";
        InputStream inputStream = Resources.getResourceAsStream(resource);
        SqlSessionFactory factory = new SqlSessionFactoryBuilder().build(inputStream);
        SqlSession session = factory.openSession();
        UserMapper mapper = session.getMapper(UserMapper.class);
        List<User> userList = mapper.selectAllUser();
        for (User user : userList) {
            System.out.println("id:" + user.getId() + " æ˜µç§°ï¼š" + user.getNickname());
        }
        session.close();

        return userList;
    }

    @RequestMapping(value = "/deleteThing/{id}", method = RequestMethod.POST)
    public String deleteThing(@PathVariable("id") int id) throws Exception {

        String resource = "com/pjhubs/SqlMapConfig.xml";
        InputStream inputStream = Resources.getResourceAsStream(resource);
        SqlSessionFactory factory = new SqlSessionFactoryBuilder().build(inputStream);
        SqlSession session = factory.openSession();

        UserMapper mapper = session.getMapper(UserMapper.class);
        mapper.deleteUserWithID(id);
        session.commit();

        session.close();

        System.out.println(id);
        return "redirect:/allThings";
    }

    @RequestMapping(value = "/modify/{id}", method = RequestMethod.POST)
    public String modifyThing(@PathVariable("id") int id, ModelMap modelMap) throws Exception {

        String resource = "com/pjhubs/SqlMapConfig.xml";
        InputStream inputStream = Resources.getResourceAsStream(resource);
        SqlSessionFactory factory = new SqlSessionFactoryBuilder().build(inputStream);
        SqlSession session = factory.openSession();

        UserMapper mapper = session.getMapper(UserMapper.class);
        User user = mapper.selectUserWithID(id);
        session.commit();

        session.close();

        modelMap.addAttribute("id", user.getId());
        modelMap.addAttribute("nickname", user.getNickname());

        return "modify";
    }

    @RequestMapping(value = "/updateStudent/{id}", method = RequestMethod.POST)
    public String updateStudent(int id, String nickname) throws Exception {

        String resource = "com/pjhubs/SqlMapConfig.xml";
        InputStream inputStream = Resources.getResourceAsStream(resource);
        SqlSessionFactory factory = new SqlSessionFactoryBuilder().build(inputStream);
        SqlSession session = factory.openSession();

        User user = new User();
        user.setId(id);
        user.setNickname(nickname);

        UserMapper mapper = session.getMapper(UserMapper.class);
        mapper.updateUserWithNickname(user);
        session.commit();

        session.close();

        return "redirect:/allThings";
    }

    @RequestMapping(value = "/insertUser", method = RequestMethod.GET)
    public String insertUser(ModelMap modelMap) {
        return "insertUser";
    }

    @RequestMapping(value = "/insertNewuser", method = RequestMethod.POST)
    public String updateStudent(String nickname, String passwd) throws Exception {

        String resource = "com/pjhubs/SqlMapConfig.xml";
        InputStream inputStream = Resources.getResourceAsStream(resource);
        SqlSessionFactory factory = new SqlSessionFactoryBuilder().build(inputStream);
        SqlSession session = factory.openSession();
        User newuser = new User();
        newuser.setNickname(nickname);
        newuser.setPasswd(passwd);

        UserMapper mapper = session.getMapper(UserMapper.class);
        mapper.insertUser(newuser);
        session.commit();
        session.close();

        return "redirect:/allThings";
    }

}

```

éµå¾ªäº†RESTfulï¼Œæ²¡æœ‰sessionï¼Œæ²¡æœ‰ç”¨æˆ·åˆ¤æ–­ï¼Œå­˜ç²¹çš„åªå®Œæˆäº†å®éªŒè¦æ±‚ã€‚

**2. åˆ©ç”¨è‡ªå®šä¹‰Springç›‘å¬æ–¹å¼ï¼Œå°†å½“å‰é¡¹ç›®çš„å†…å­˜æƒ…å†µæ¯è¿‡5ç§’é’Ÿè®°å½•åˆ°æ•°æ®åº“ä¸€æ¬¡ã€‚å®Œæˆä¸šåŠ¡æ¨¡å—å’Œåå°ç®¡ç†æ¨¡å—åŒæ—¶è¿è¡Œçš„æ•ˆæœã€‚**

è¯¥é¢˜ç›®ç»§æ‰¿å®éªŒä¸€ï¼Œä¹‹å‰åªæ˜¯æŠŠtotalMemoryè®°å½•ä¸‹æ¥ï¼Œè¿™å›éœ€è¦è®°å½•ä¸‹maxMemoryã€totalMemoryã€freeMemoryï¼Œæ‹¿åˆ°è¿™ä¸‰ä¸ªå€¼éœ€è¦ç”¨åˆ°Runtimeç±»ç›¸å…³æ–¹æ³•ï¼Œæƒ³è¦å®Œæˆå®éªŒï¼Œéœ€è¦åšçš„äº‹æƒ…å¦‚ä¸‹ï¼Œ

åœ¨`dispatcher-servlet.xml`ä¸­çš„`xmlns`ä¸‹æ·»åŠ 
```xml
xmlns:task="http://www.springframework.org/schema/task"  
```

åœ¨`xsi:schemaLocation`å¡«å†™ï¼Œ
```xml
http://www.springframework.org/schema/task  
http://www.springframework.org/schema/task/spring-task-3.2.xsd  
```

æœ€ååœ¨è¯¥æ–‡ä»¶ä¸­å†™ä¸‹taskä»»åŠ¡æ‰«ææ³¨è§£ï¼Œä¾›åç»­æ–‡ä»¶ä¸­ä½¿ç”¨ï¼Œ
```xml
<task:annotation-driven/>  
<!-- base-packageå¡«å†™éœ€è¦è¿›è¡Œtaskä»»åŠ¡æ‰«æçš„åŒ… -->
<context:component-scan base-package="com.pjhubs.controller"></context:component-scan>
```

æ¥ç€å†é‡å¤ä¸€éä¹‹å‰UserMapperè¦åšçš„äº‹æƒ…å³å¯å†™å…¥ï¼Œ

```java
@Controller
// æ–°å¢
@Component
public class thingsController {
    // æ–°å¢
    @Scheduled(cron="0/5 * * * * ? ") //é—´éš”5ç§’æ‰§è¡Œ
    public void taskCycle() throws Exception {
        Runtime runtime = Runtime.getRuntime();
        System.out.println(runtime.maxMemory() / 1024 / 1024 + "," + runtime.totalMemory() / 1024 / 1024 + "," + runtime.freeMemory() / 1024 / 1024);


        String resource = "com/pjhubs/SqlMapConfig.xml";
        InputStream inputStream = Resources.getResourceAsStream(resource);
        SqlSessionFactory factory = new SqlSessionFactoryBuilder().build(inputStream);
        SqlSession session = factory.openSession();
        Memory memory = new Memory();
        memory.setMax(runtime.maxMemory() / 1024 / 1024);
        memory.setTotal(runtime.totalMemory() / 1024 / 1024);
        memory.setFree(runtime.freeMemory() / 1024 / 1024);


        MemoryMapper mapper = session.getMapper(MemoryMapper.class);
        mapper.insertData(memory);
        session.commit();
        session.close();

    }
    ......
```
ä¸æƒ³å†™è®²è§£äº†ï¼Œå°±è¿™æ ·å§ã€‚
